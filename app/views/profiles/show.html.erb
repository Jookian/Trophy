<div class="container py-4 mb-5 text-center page-profile">

  <!-- PHOTO DE PROFIL -->
  <div class="mb-4">
    <% if @user.photo.attached? %>
      <%= image_tag @user.photo,
            class: "rounded-circle mb-3 mx-auto d-block",
            style: "width: 120px; height: 120px; object-fit: cover;" %>
    <% else %>
      <div class="rounded-circle bg-light d-flex align-items-center justify-content-center mb-3 mx-auto"
           style="width: 120px; height: 120px;">
        <span class="text-muted">Photo</span>
      </div>
    <% end %>

    <button class="btn-profile"
            onclick="toggleForm('photo-form')">
      Changer la photo
    </button>

    <div id="photo-form" class="mt-3" style="display:none;">
      <%= form_with model: @user, url: profile_path, method: :patch, class: "d-flex flex-column align-items-center" do |f| %>
        <%= f.file_field :photo, class: "form-control mb-2 w-75" %>
        <%= f.submit "Enregistrer", class: "btn btn-primary btn-sm" %>
      <% end %>
    </div>
  </div>

  <!-- PSEUDO -->
  <div class="card mb-3 mx-auto" style="max-width: 420px;">
    <div class="card-body text-center">

      <h5 class="card-title mb-2">Pseudo</h5>

      <p class="fw-semibold mb-2">
        <%= @user.name.presence || "Non renseigné" %>
      </p>

      <button class="btn-profile"
              onclick="toggleForm('name-form')">
        Modifier mon pseudo
      </button>

      <div id="name-form" class="mt-3" style="display:none;">
        <%= form_with model: @user, url: profile_path, method: :patch, class: "d-flex flex-column align-items-center" do |f| %>
          <%= f.text_field :name, class: "form-control mb-2 w-75 text-center" %>
          <%= f.submit "Enregistrer", class: "btn btn-primary btn-sm" %>
        <% end %>
      </div>

    </div>
  </div>

  <!-- PHRASE DE MOTIVATION -->
  <div class="card mb-3 mx-auto" style="max-width: 420px;">
    <div class="card-body text-center">

      <h5 class="card-title mb-2">Phrase de motivation</h5>

      <p class="text-muted">
        <%= @user.motivation_text.presence || "Non renseignée" %>
      </p>

      <button class="btn-profile"
              onclick="toggleForm('motivation-form')">
        Modifier ma phrase
      </button>

      <div id="motivation-form" class="mt-3" style="display:none;">
        <%= form_with model: @user, url: profile_path, method: :patch, class: "d-flex flex-column align-items-center" do |f| %>
          <%= f.text_area :motivation_text,
                class: "form-control mb-2 w-75 text-center",
                rows: 3 %>
          <%= f.submit "Enregistrer", class: "btn btn-primary btn-sm" %>
        <% end %>
      </div>

    </div>
  </div>

  <!-- RÉCAP' DE VOTRE AVANCÉE - Badges des objectifs complétés -->
  <% if @completed_goals.any? %>
    <div class="card mb-3 mx-auto completed-goals-card" style="max-width: 420px;">
      <div class="card-body text-center">
        <h5 class="card-title mb-3">Récap' de votre avancée</h5>

        <div class="completed-goals-badges">
          <% @completed_goals.each do |goal| %>
            <div class="completed-goal-badge" onclick="toggleBadgeTooltip(this)">
              <%= image_tag goal.icon_path, class: "completed-goal-icon" %>
              <div class="badge-tooltip">
                <span><%= "Badge de réussite pour #{goal.name}".split.each_slice(4).map { |words| words.join(' ') }.join('<br>').html_safe %></span>
                <button class="tooltip-close" onclick="event.stopPropagation(); closeBadgeTooltip(this)">✕</button>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>

  <!-- COMPTEUR DE TROPHÉES -->
  <div class="card text-center mb-3 mx-auto" style="max-width: 420px;">
    <div class="card-body">
      <h5 class="card-title">Trophées remportés</h5>
      <p class="display-6 fw-bold mb-0">
        <%= @trophies_count %>
      </p>
    </div>
  </div>

  <!-- LISTE DES TROPHÉES -->
  <div class="trophies-section mx-auto" style="max-width: 420px;">
    <h5 class="card-title mb-3 text-center">Mes trophées</h5>

    <% if @user_badges.any? %>
      <div class="trophies-grid">
        <% @user_badges.each do |user_badge| %>
          <div class="trophy-card-profile">
            <div class="trophy-goal-badge">
              <%= image_tag user_badge.badge.goal.icon_path, class: "trophy-goal-icon" %>
            </div>
            <div class="trophy-card-content">
              <strong class="trophy-title"><%= user_badge.badge.title %></strong>
              <small class="trophy-description"><%= user_badge.badge.description %></small>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <p class="text-muted text-center mb-0">Aucun trophée pour le moment.</p>
    <% end %>
  </div>
</div>

<!-- JS MINIMAL -->
<script>
  function toggleForm(id) {
    const el = document.getElementById(id);
    el.style.display = el.style.display === "none" ? "block" : "none";
  }

  function toggleBadgeTooltip(badge) {
    // Fermer tous les autres tooltips
    document.querySelectorAll('.completed-goal-badge.tooltip-active').forEach(b => {
      if (b !== badge) b.classList.remove('tooltip-active');
    });

    const tooltip = badge.querySelector('.badge-tooltip');
    tooltip.classList.remove('tooltip-left', 'tooltip-right');

    // Toggle le tooltip actuel
    badge.classList.toggle('tooltip-active');

    // Ajuster la position si le tooltip dépasse
    if (badge.classList.contains('tooltip-active')) {
      const rect = badge.getBoundingClientRect();
      const tooltipRect = tooltip.getBoundingClientRect();
      const viewportWidth = window.innerWidth;

      // Si dépasse à gauche
      if (tooltipRect.left < 10) {
        tooltip.classList.add('tooltip-right');
      }
      // Si dépasse à droite
      else if (tooltipRect.right > viewportWidth - 10) {
        tooltip.classList.add('tooltip-left');
      }
    }
  }

  function closeBadgeTooltip(btn) {
    btn.closest('.completed-goal-badge').classList.remove('tooltip-active');
  }

  // Fermer les tooltips au clic en dehors
  document.addEventListener('click', function(e) {
    if (!e.target.closest('.completed-goal-badge')) {
      document.querySelectorAll('.completed-goal-badge.tooltip-active').forEach(b => {
        b.classList.remove('tooltip-active');
      });
    }
  });
</script>

<div class="page-goals" data-controller="confirm">

<!-- Header -->
<main>
<div class="goal-show-header">
  <%= link_to dashboard_path, class: "back-link" do %>
    <%= image_tag "icon-back.svg", alt: "Retour" %>
  <% end %>

  <h1><%= @goal.name %></h1>
</div>

<!-- Progression (bas√©e uniquement sur les troph√©es classiques) -->
<div class="progress-wrapper">
<div class="progress-container">
  <% total = @badges.count %>
  <% done = @validated_badges.count { |id| @badges.pluck(:id).include?(id) } %>
  <% percent = total.zero? ? 0 : ((done.to_f / total) * 100).round %>

  <div class="progress-bar" style="width: <%= percent %>%"></div>
  <div class="progress-text"><%= percent %>%</div>
</div>
</div>

<div class="trophy-list-wrapper">
<div class="trophy-list">
  <% @badges.each do |badge| %>
    <div class="trophy-card">
      <div class="trophy-card-text">
        <h3><%= badge.title %></h3>

        <p><%= badge.description %></p>
      </div>

      <div class="trophy-card-action">
  <% user_badge = current_user.user_badges.find_by(badge: badge) %>

  <% if user_badge %>
    <!-- Bouton annuler le trophy -->
    <button
      type="button"
      class="validate-btn"
      data-action="click->confirm#open"
      data-confirm-form-id="delete-user-badge-<%= user_badge.id %>">
      ‚úîÔ∏è
    </button>

    <!-- Form cach√© pour la suppression -->
    <%= form_with model: user_badge,
          method: :delete,
          html: {
            id: "delete-user-badge-#{user_badge.id}",
            style: "display:none;"
          } do %>
    <% end %>

  <% else %>
    <!-- Bouton valider le trophy -->
    <%= button_to user_badges_path(badge_id: badge.id),
          method: :post,
          class: "validate-btn" do %>
      <%= image_tag "icon-trophy-small.svg", class: "validate-icon" %>
    <% end %>
  <% end %>
</div>
      </div>
  <% end %>
</div>
</div>

<!-- Troph√©es cach√©s (visibles uniquement si objectif compl√©t√© √† 100%) -->
<% if @goal_completed && @hidden_badges.any? %>
  <div class="hidden-trophies-section">
    <p class="hidden-kicker">üéâ Objectif valid√© √† 100 %</p>

    <h3 class="hidden-subtitle">Trophy secrets d√©bloqu√©s</h3>
    <p class="hidden-description">
    Ils ne comptent pas dans ta progression globale.<br>
    Juste des troph√©es pour flex un peu ‚ú®
  </p>

    <div class="trophy-list-wrapper">
      <div class="trophy-list hidden-trophies">
        <% @hidden_badges.each do |badge| %>
          <div class="trophy-card">
            <div class="trophy-card-text">
              <h3><%= badge.title %></h3>
              <p><%= badge.description %></p>
            </div>

            <div class="trophy-card-action">
              <% user_badge = current_user.user_badges.find_by(badge: badge) %>

              <% if user_badge %>
                <button
                  type="button"
                  class="validate-btn"
                  data-action="click->confirm#open"
                  data-confirm-form-id="delete-user-badge-<%= user_badge.id %>">
                  ‚úîÔ∏è
                </button>
                <%= form_with model: user_badge,
                      method: :delete,
                      html: {
                        id: "delete-user-badge-#{user_badge.id}",
                        style: "display:none;"
                      } do %>
                <% end %>
              <% else %>
                <%= button_to user_badges_path(badge_id: badge.id),
                      method: :post,
                      class: "validate-btn" do %>
                  <%= image_tag "icon-trophy-small.svg", class: "validate-icon" %>
                <% end %>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>
<% end %>

<div class="container-photos">

<%= form_with url: "/goals/#{@goal.id}/photos",
              method: :post,
              local: true,
              html: { multipart: true, class: "upload-form" } do %>

  <label for="photos-input" class="custom-upload-button">
  ‚ûï‚Äã Ajouter des photos
  </label>

  <%= file_field_tag "photos[]",
      id: "photos-input",
      multiple: true,
      onchange: "this.form.submit()",
      style: "display:none;" %>

<% end %>

<div data-controller="gallery">

  <div class="photos-carousel">
    <% @goal.photos.each_with_index do |photo, index| %>
      <%= image_tag photo,
            height: 120,
            class: "carousel-photo",
            data: {
              action: "click->gallery#open",
              gallery_index_value: index
            } %>
    <% end %>
  </div>

  <div
    class="gallery-modal"
    data-gallery-target="modal">

    <button class="gallery-close" data-action="gallery#close">‚úï</button>

    <div class="gallery-content">
      <% @goal.photos.each do |photo| %>
        <%= image_tag photo, class: "gallery-image" %>
      <% end %>
    </div>

  </div>

</div>

<div id="trophy-popup"
     class="trophy-popup"
     data-controller="trophy-popup"
     data-trophy-popup-show-value="<%= flash[:notice] == 'trophy_unlocked' %>">

  <div class="trophy-popup-content">

    <div class="trophy-icon">
  <%= image_tag "icon-trophy.png", alt: "Trophy", class: "trophy-icon-img" %>
</div>

    <h2> F√©licitations <%= current_user.name.presence || "Champion" %>  !</h2>
    <p class="subtitle">Nouveau Trophy d√©bloqu√©</p>

    <div class="trophy-card-popup">
  <% if @badge.present? %>
    <h3><%= @badge.title %></h3>
  <% else %>
    <h3><%= @goal.name %></h3> <!-- fallback si aucun badge d√©bloqu√© -->
  <% end %>
</div>

    <div class="popup-buttons">
      <button class="popup-close" data-action="trophy-popup#close">OK</button>

      <button class="popup-share">
        Partager √† un(e) ami(e)
      </button>
    </div>
  </div>

</div>
<div class="confirm-popup" data-confirm-target="popup">
    <div class="confirm-popup-content">
      <p>Es-tu s√ªr de vouloir annuler ce Trophy ?</p>

      <div class="confirm-buttons">
        <button data-action="confirm#confirm">Oui</button>
        <button data-action="confirm#close">Non</button>
      </div>
    </div>
  </div>
</div>

</main>
</div>

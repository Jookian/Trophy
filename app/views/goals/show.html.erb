<div data-controller="confirm">

<!-- Header -->

<div class="goal-show-header">
  <%= link_to dashboard_path, class: "back-link" do %>
    <%= image_tag "icon-back.svg", alt: "Retour" %>
  <% end %>

  <h1><%= @goal.name %></h1>
</div>

<!-- Progression -->
<div class="progress-container">
  <% total = @goal.badges.count %>
  <% done = @validated_badges.count { |id| @goal.badges.pluck(:id).include?(id) } %>
  <% percent = total.zero? ? 0 : ((done.to_f / total) * 100).round %>

  <div class="progress-bar" style="width: <%= percent %>%"></div>
  <div class="progress-text"><%= percent %>%</div>
</div>

<div class="trophy-list">
  <% @badges.each do |badge| %>
    <div class="trophy-card">
      <div class="trophy-card-text">
        <h3><%= badge.title %></h3>

        <p><%= badge.description %></p>
      </div>

      <div class="trophy-card-action">
  <% user_badge = current_user.user_badges.find_by(badge: badge) %>

  <% if user_badge %>
    <!-- Bouton annuler le trophy -->
    <button
      type="button"
      class="validate-btn"
      data-action="click->confirm#open"
      data-confirm-form-id="delete-user-badge-<%= user_badge.id %>">
      ‚Ü©Ô∏è
    </button>

    <!-- Form cach√© pour la suppression -->
    <%= form_with model: user_badge,
          method: :delete,
          html: {
            id: "delete-user-badge-#{user_badge.id}",
            style: "display:none;"
          } do %>
    <% end %>

  <% else %>
    <!-- Bouton valider le trophy -->
    <%= button_to user_badges_path(badge_id: badge.id),
          method: :post,
          class: "validate-btn" do %>
      <%= image_tag "icon-trophy-small.svg", class: "validate-icon" %>
    <% end %>
  <% end %>
</div>
      </div>
  <% end %>
</div>

<h3>Photos inspirantes</h3>

<%= form_with url: "/goals/#{@goal.id}/photos",
              method: :post,
              local: true,
              html: { multipart: true, class: "upload-form" } do %>

  <label for="photos-input" class="custom-upload-button">
    üì∑ <span>Ajouter des photos</span>
  </label>

  <%= file_field_tag "photos[]",
      id: "photos-input",
      multiple: true,
      onchange: "this.form.submit()",
      style: "display:none;" %>

<% end %>

<div class="photos-carousel">
  <% @goal.photos.each do |photo| %>
    <%= link_to "/goals/#{@goal.id}/gallery" do %>
      <%= image_tag photo, height: 120 %>
    <% end %>
  <% end %>
</div>

<div id="trophy-popup"
     class="trophy-popup"
     data-controller="trophy-popup"
     data-trophy-popup-show-value="<%= flash[:notice] == 'trophy_unlocked' %>">

  <div class="trophy-popup-content">

    <div class="trophy-icon">
  <%= image_tag "icon-trophy.png", alt: "Trophy", class: "trophy-icon-img" %>
</div>

    <h2> F√©licitations <%= current_user.name %>  !</h2>
    <p class="subtitle">Vous avez re√ßu un succ√®s</p>

    <div class="trophy-card-popup">
  <% if @badge.present? %>
    <h3><%= @badge.title %></h3>
  <% else %>
    <h3><%= @goal.name %></h3> <!-- fallback si aucun badge d√©bloqu√© -->
  <% end %>
</div>

    <div class="popup-buttons">
      <button class="popup-close" data-action="trophy-popup#close">OK</button>

      <button class="popup-share">
        Partager √† un ami
      </button>
    </div>
  </div>

</div>
<div class="confirm-popup" data-confirm-target="popup">
    <div class="confirm-popup-content">
      <p>√ätes-vous s√ªr de vouloir annuler ce trophy ?</p>

      <div class="confirm-buttons">
        <button data-action="confirm#confirm">Oui</button>
        <button data-action="confirm#close">Non</button>
      </div>
    </div>
  </div>
</div>
